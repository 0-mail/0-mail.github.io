<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TempMail - Disposable Email for Devs</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Generate disposable email addresses instantly. Built for developers.">
    <meta name="keywords" content="temporary email, disposable email, temp mail, email generator, developer tools">
    <meta name="author" content="TempMail">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="/">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="TempMail - Disposable Email for Devs">
    <meta property="og:description" content="Generate disposable email addresses instantly. Built for developers.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/">
    <meta property="og:image" content="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='2' y='4' width='20' height='16' rx='2'/%3E%3Cpolyline points='2 10 12 14 22 10'/%3E%3Cline x1='6' y1='8' x2='10' y2='12'/%3E%3Cline x1='14' y1='12' x2='18' y2='8'/%3E%3C/svg%3E">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="TempMail - Disposable Email for Devs">
    <meta name="twitter:description" content="Generate disposable email addresses instantly. Built for developers.">
    <meta name="twitter:image" content="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='2' y='4' width='20' height='16' rx='2'/%3E%3Cpolyline points='2 10 12 14 22 10'/%3E%3Cline x1='6' y1='8' x2='10' y2='12'/%3E%3Cline x1='14' y1='12' x2='18' y2='8'/%3E%3C/svg%3E">

    <!-- Favicon (Inline SVG) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='2' y='4' width='20' height='16' rx='2'/%3E%3Cpolyline points='2 10 12 14 22 10'/%3E%3Cline x1='6' y1='8' x2='10' y2='12'/%3E%3Cline x1='14' y1='12' x2='18' y2='8'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='2' y='4' width='20' height='16' rx='2'/%3E%3Cpolyline points='2 10 12 14 22 10'/%3E%3Cline x1='6' y1='8' x2='10' y2='12'/%3E%3Cline x1='14' y1='12' x2='18' y2='8'/%3E%3C/svg%3E">

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'GA_MEASUREMENT_ID');

        function trackEmailGeneration() {
            gtag('event', 'email_generated', {
                'event_category': 'user_action',
                'event_label': 'new_temp_email'
            });
        }

        function trackEmailCheck() {
            gtag('event', 'check_emails', {
                'event_category': 'user_action',
                'event_label': 'check_inbox'
            });
        }

        function trackEmailCopy() {
            gtag('event', 'email_copied', {
                'event_category': 'user_action',
                'event_label': 'copy_to_clipboard'
            });
        }
    </script>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fira Code Font -->
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;700&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS (for tooltips and modal) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            @apply bg-gray-900 text-white overflow-hidden;
        }

        .loading-spinner {
            @apply inline-block w-4 h-4 border-2 border-t-transparent border-white rounded-full animate-spin;
        }

        .tooltip .tooltip-inner {
            @apply font-mono text-sm px-2 py-1 rounded;
        }

        .tooltip.bs-tooltip-top .tooltip-inner.alert-info {
            @apply bg-blue-800 text-white border-l-4 border-blue-400;
        }

        .tooltip.bs-tooltip-top .tooltip-inner.alert-success {
            @apply bg-green-800 text-white border-l-4 border-green-400;
        }

        .tooltip.bs-tooltip-top .tooltip-inner.alert-warning {
            @apply bg-yellow-800 text-white border-l-4 border-yellow-400;
        }

        .tooltip.bs-tooltip-top .tooltip-inner.alert-danger {
            @apply bg-red-800 text-white border-l-4 border-red-400;
        }
    </style>
</head>
<body>
    <div class="flex flex-col min-h-screen">
        <div class="container mx-auto px-4 py-4 flex-grow">
            <div class="flex h-[calc(100vh-2rem)]">
                <!-- Sidebar with About Section -->
                <div class="w-full lg:w-1/3 bg-gray-800 rounded-lg p-6 mr-4 overflow-y-auto border border-white !important">
                    <h2 class="text-xl font-bold text-white !important mb-4">About TempMail</h2>
                    <p class="text-white !important mb-4">Instant disposable email addresses for developers. Use for testing, signups, or keeping your main inbox clean.</p>
                    <ul class="list-none">
                        <li class="mb-2"><i class="fas fa-check text-blue-100 !important mr-2"></i><span class="text-white !important">API testing and automation</span></li>
                        <li class="mb-2"><i class="fas fa-check text-blue-100 !important mr-2"></i><span class="text-white !important">Quick signups without spam</span></li>
                        <li class="mb-2"><i class="fas fa-check text-blue-100 !important mr-2"></i><span class="text-white !important">Privacy-first design</span></li>
                        <li class="mb-2"><i class="fas fa-check text-blue-100 !important mr-2"></i><span class="text-white !important">Local mailbox storage</span></li>
                    </ul>
                    <h3 class="text-lg font-semibold text-white !important mt-4 mb-3">Features</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <ul class="list-none">
                            <li class="mb-2"><i class="fas fa-shield-alt text-blue-100 !important mr-2"></i><span class="text-white !important">Anonymous</span></li>
                            <li class="mb-2"><i class="fas fa-bolt text-blue-100 !important mr-2"></i><span class="text-white !important">Instant Generation</span></li>
                            <li class="mb-2"><i class="fas fa-mobile-alt text-blue-100 !important mr-2"></i><span class="text-white !important">Mobile-Friendly</span></li>
                        </ul>
                        <ul class="list-none">
                            <li class="mb-2"><i class="fas fa-user-secret text-blue-100 !important mr-2"></i><span class="text-white !important">No Registration</span></li>
                            <li class="mb-2"><i class="fas fa-sync-alt text-blue-100 !important mr-2"></i><span class="text-white !important">Real-time Checking</span></li>
                            <li class="mb-2"><i class="fas fa-copy text-blue-100 !important mr-2"></i><span class="text-white !important">One-Click Copy</span></li>
                        </ul>
                    </div>
                </div>

                <!-- Email Card -->
                <div class="w-full lg:w-2/3 bg-gray-800 rounded-lg flex flex-col border border-white !important">
                    <div class="bg-gray-900 rounded-t-lg p-6 text-center">
                        <h1 class="text-2xl font-bold text-white !important">TempMail</h1>
                        <p class="text-white !important">Disposable Email for Devs</p>
                    </div>
                    <div class="p-6 flex-grow flex flex-col">
                        <!-- Email Generation Section -->
                        <div class="mb-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                <button class="bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition" onclick="generateEmail()" data-bs-toggle="tooltip" data-bs-placement="top" title="">
                                    <i class="fas fa-plus-circle mr-2"></i>Generate Email
                                </button>
                                <select class="form-select bg-gray-900 text-white border-gray-600 rounded-lg py-2" id="mailboxSelector" onchange="switchMailbox()">
                                    <option value="">Select Mailbox</option>
                                </select>
                            </div>
                            <p class="text-white !important text-sm mt-2"><i class="fas fa-info-circle mr-1"></i>Mailboxes saved locally in browser</p>
                        </div>

                        <!-- Current Email Display -->
                        <div id="currentEmailSection" class="hidden flex-grow">
                            <div class="flex justify-between items-center mb-3">
                                <h5 class="text-lg font-semibold text-white !important"><i class="fas fa-inbox mr-2"></i>Current Email</h5>
                                <div class="flex gap-2">
                                    <button class="bg-green-600 hover:bg-green-700 text-white py-1 px-3 rounded-md" onclick="copyEmail()" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy to clipboard">
                                        <i class="fas fa-copy mr-1"></i>Copy
                                    </button>
                                    <button class="bg-red-600 hover:bg-red-700 text-white py-1 px-3 rounded-md" onclick="deleteMailbox()" data-bs-toggle="tooltip" data-bs-placement="top" title="Delete mailbox">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="bg-gray-900 border border-white !important rounded-lg p-4 text-green-400 cursor-pointer hover:bg-blue-600/20 transition" id="emailDisplay" onclick="copyEmail()" data-bs-toggle="tooltip" data-bs-placement="top" title="Click to copy email">
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-envelope mr-2 text-white !important"></i>
                                    <span>No email generated</span>
                                </div>
                            </div>

                            <div class="text-center mb-4">
                                <div class="flex gap-2 justify-center">
                                    <button class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition" id="refreshBtn" onclick="checkEmails()" data-bs-toggle="tooltip" data-bs-placement="top" title="Check emails">
                                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                                    </button>
                                    <button class="bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-lg transition" onclick="toggleAutoRefresh()" id="autoRefreshBtn" data-bs-toggle="tooltip" data-bs-placement="top" title="Toggle auto-refresh">
                                        <i class="fas fa-clock mr-2"></i>Auto-Refresh: OFF
                                    </button>
                                </div>
                                <p class="text-white !important text-sm mt-2"><i class="fas fa-lightbulb mr-1"></i>Click email to copy instantly</p>
                            </div>
                        </div>

                        <!-- Email List -->
                        <div id="emailList" class="hidden flex flex-col">
                            <div class="flex justify-between items-center mb-3">
                                <h5 class="text-lg font-semibold text-white !important"><i class="fas fa-envelope-open mr-2"></i>Inbox (<span id="emailCount">0</span>)</h5>
                                <button class="bg-gray-600 hover:bg-gray-500 text-white py-1 px-3 rounded-md" onclick="clearAllEmails()" data-bs-toggle="tooltip" data-bs-placement="top" title="Clear all emails">
                                    <i class="fas fa-broom mr-1"></i>Clear
                                </button>
                            </div>
                            <div id="emails" class="overflow-y-auto max-h-[200px]"></div>
                            <div id="emptyInbox" class="text-center py-4 hidden">
                                <i class="fas fa-inbox text-3xl text-white !important mb-3"></i>
                                <p class="text-white !important">No emails found</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Animation Overlay -->
    <div class="hidden fixed inset-0 bg-gray-900/90 flex items-center justify-center" id="refreshOverlay">
        <div class="text-white text-center">
            <p class="text-xl animate-pulse">Checking emails...</p>
        </div>
    </div>

    <!-- Email Content Modal -->
    <div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-gray-800 border border-white !important rounded-lg">
                <div class="modal-header bg-gray-900 text-white !important rounded-t-lg border-b border-white !important">
                    <h5 class="modal-title" id="emailModalLabel"><i class="fas fa-envelope-open mr-2"></i>Email Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-6">
                    <div class="mb-3">
                        <strong class="text-blue-100 !important">From:</strong> <span id="modalFrom" class="text-white !important"></span>
                    </div>
                    <div class="mb-3">
                        <strong class="text-blue-100 !important">Subject:</strong> <span id="modalSubject" class="text-white !important"></span>
                    </div>
                    <div class="mb-3">
                        <strong class="text-blue-100 !important">Date:</strong> <span id="modalDate" class="text-white !important"></span>
                    </div>
                    <div class="mb-3">
                        <strong class="text-blue-100 !important">Content:</strong>
                        <div id="modalContent" class="bg-gray-900 p-4 rounded-lg border border-white !important max-h-[400px] overflow-y-auto text-white !important"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>

    <script>
        class TempMail {
            constructor() {
                try {
                    this.currentEmail = '';
                    this.currentToken = '';
                    this.emails = [];
                    this.refreshInterval = null;
                    this.apiBase = 'https://api.mail.tm';
                    this.savedMailboxes = {};
                    this.autoRefreshEnabled = false;

                    this.loadSavedData();
                    this.updateMailboxSelector();
                } catch (error) {
                    console.error('TempMail constructor error:', error.message, error.stack);
                }
            }

            initializeTooltips() {
                try {
                    if (typeof bootstrap === 'undefined' || !bootstrap.Tooltip) {
                        console.warn('Bootstrap Tooltip not available yet');
                        return;
                    }
                    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                    tooltipTriggerList.forEach(triggerEl => {
                        if (!bootstrap.Tooltip.getInstance(triggerEl)) {
                            new bootstrap.Tooltip(triggerEl);
                        }
                    });
                } catch (error) {
                    console.error('initializeTooltips error:', error.message, error.stack);
                }
            }

            async generateEmail() {
                try {
                    const btn = document.querySelector('button[onclick="generateEmail()"]');
                    if (!btn) throw new Error('Generate email button not found');
                    this.showStatus(btn, 'Generating email...', 'info');

                    const domainsResponse = await fetch(`${this.apiBase}/domains`, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    if (!domainsResponse.ok) {
                        throw new Error(`Failed to get domains: ${domainsResponse.status}`);
                    }
                    const domains = await domainsResponse.json();

                    if (!domains['hydra:member'] || !Array.isArray(domains['hydra:member']) || domains['hydra:member'].length === 0) {
                        throw new Error('No domains available');
                    }

                    const domain = domains['hydra:member'][0].domain;
                    if (!domain) throw new Error('Domain not found in response');
                    const username = this.generateRandomString(8);
                    this.currentEmail = `${username}@${domain}`;

                    const createResponse = await fetch(`${this.apiBase}/accounts`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            address: this.currentEmail,
                            password: 'temppassword123'
                        })
                    });

                    if (!createResponse.ok) {
                        const errorData = await createResponse.json().catch(() => ({}));
                        throw new Error(errorData.message || `Failed to create account: ${createResponse.status}`);
                    }

                    const authResponse = await fetch(`${this.apiBase}/token`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            address: this.currentEmail,
                            password: 'temppassword123'
                        })
                    });

                    if (!authResponse.ok) {
                        throw new Error(`Failed to get authentication token: ${authResponse.status}`);
                    }

                    const authData = await authResponse.json();
                    if (!authData.token) throw new Error('No token received');
                    this.currentToken = authData.token;

                    this.emails = [];
                    this.updateEmailDisplay();
                    this.updateEmailList();

                    const currentEmailSection = document.getElementById('currentEmailSection');
                    const emailDisplay = document.getElementById('emailDisplay');
                    const emailList = document.getElementById('emailList');
                    if (!currentEmailSection || !emailDisplay || !emailList) {
                        throw new Error('Required DOM elements missing');
                    }

                    currentEmailSection.classList.remove('hidden');
                    emailDisplay.innerHTML = `<span>${this.currentEmail}</span>`;
                    emailList.classList.remove('hidden');

                    this.showStatus(btn, 'Email generated!', 'success');

                    this.saveMailbox();
                    this.updateMailboxSelector();
                    this.initializeTooltips();

                    if (typeof trackEmailGeneration === 'function') {
                        trackEmailGeneration();
                    }

                    this.startAutoRefresh();
                } catch (error) {
                    const btn = document.querySelector('button[onclick="generateEmail()"]');
                    if (btn) this.showStatus(btn, 'Error generating email', 'danger');
                    console.error('generateEmail error:', error.message, error.stack);
                }
            }

            generateRandomString(length) {
                try {
                    const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
                    let result = '';
                    for (let i = 0; i < length; i++) {
                        result += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                    return result;
                } catch (error) {
                    console.error('generateRandomString error:', error.message, error.stack);
                    return 'random' + Date.now();
                }
            }

            async checkEmails() {
                try {
                    if (!this.currentEmail || !this.currentToken) {
                        const btn = document.getElementById('refreshBtn');
                        if (btn) this.showStatus(btn, 'Generate an email first', 'warning');
                        return;
                    }

                    const btn = document.getElementById('refreshBtn');
                    const refreshOverlay = document.getElementById('refreshOverlay');
                    if (!btn || !refreshOverlay) throw new Error('Required DOM elements missing');

                    this.setRefreshButton(true);
                    refreshOverlay.classList.remove('hidden');

                    if (typeof trackEmailCheck === 'function') {
                        trackEmailCheck();
                    }

                    const response = await fetch(`${this.apiBase}/messages`, {
                        headers: {
                            'Authorization': `Bearer ${this.currentToken}`,
                            'Accept': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to fetch messages: ${response.status}`);
                    }

                    const data = await response.json();
                    const messages = Array.isArray(data['hydra:member']) ? data['hydra:member'] : [];

                    if (messages.length > 0) {
                        const existingIds = new Set(this.emails.map(email => email.id));
                        const newEmails = messages.filter(msg => msg.id && !existingIds.has(msg.id));

                        if (newEmails.length > 0) {
                            this.emails = [...newEmails, ...this.emails];
                            this.showStatus(btn, `${newEmails.length} new email(s)!`, 'success');
                            this.updateEmailList();
                            this.saveMailbox();
                            this.updateMailboxSelector();
                        } else {
                            this.showStatus(btn, 'No new emails', 'info');
                        }
                    } else {
                        this.showStatus(btn, 'Inbox empty', 'info');
                    }
                } catch (error) {
                    const btn = document.getElementById('refreshBtn');
                    if (btn) this.showStatus(btn, 'Error checking emails', 'danger');
                    console.error('checkEmails error:', error.message, error.stack);
                } finally {
                    this.setRefreshButton(false);
                    const refreshOverlay = document.getElementById('refreshOverlay');
                    if (refreshOverlay) refreshOverlay.classList.add('hidden');
                    this.initializeTooltips();
                }
            }

            async getEmailContent(messageId) {
                try {
                    if (!messageId) throw new Error('Invalid message ID');
                    const response = await fetch(`${this.apiBase}/messages/${messageId}`, {
                        headers: {
                            'Authorization': `Bearer ${this.currentToken}`,
                            'Accept': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to fetch message content: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('getEmailContent error:', error.message, error.stack);
                    return null;
                }
            }

            loadSavedData() {
                try {
                    const saved = localStorage.getItem('tempmail_mailboxes');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        if (typeof parsed === 'object' && parsed !== null) {
                            this.savedMailboxes = parsed;
                        } else {
                            throw new Error('Invalid mailbox data format');
                        }
                    }
                } catch (error) {
                    this.savedMailboxes = {};
                    console.error('loadSavedData error:', error.message, error.stack);
                    localStorage.removeItem('tempmail_mailboxes');
                }
            }

            saveMailbox() {
                try {
                    if (!this.currentEmail) return;
                    const mailboxData = {
                        email: this.currentEmail,
                        token: this.currentToken,
                        emails: this.emails,
                        lastUsed: new Date().toISOString()
                    };
                    this.savedMailboxes[this.currentEmail] = mailboxData;
                    localStorage.setItem('tempmail_mailboxes', JSON.stringify(this.savedMailboxes));
                    localStorage.setItem('tempmail_last_used', this.currentEmail);
                } catch (error) {
                    console.error('saveMailbox error:', error.message, error.stack);
                }
            }

            loadMailbox(email) {
                try {
                    const mailbox = this.savedMailboxes[email];
                    if (!mailbox) throw new Error('Mailbox not found');

                    this.stopAutoRefresh();

                    this.currentEmail = mailbox.email;
                    this.currentToken = mailbox.token;
                    this.emails = mailbox.emails || [];

                    const currentEmailSection = document.getElementById('currentEmailSection');
                    const emailDisplay = document.getElementById('emailDisplay');
                    if (!currentEmailSection || !emailDisplay) throw new Error('Required DOM elements missing');

                    currentEmailSection.classList.remove('hidden');
                    emailDisplay.innerHTML = `<span>${this.currentEmail}</span>`;
                    this.updateEmailList();
                    this.updateMailboxSelector();

                    localStorage.setItem('tempmail_last_used', email);

                    const selector = document.getElementById('mailboxSelector');
                    if (selector) this.showStatus(selector, `Switched to ${email}`, 'success');
                    this.startAutoRefresh();
                    this.initializeTooltips();
                } catch (error) {
                    console.error('loadMailbox error:', error.message, error.stack);
                }
            }

            getLastUsedMailbox() {
                try {
                    return localStorage.getItem('tempmail_last_used') || '';
                } catch (error) {
                    console.error('getLastUsedMailbox error:', error.message, error.stack);
                    return '';
                }
            }

            updateMailboxSelector() {
                try {
                    const selector = document.getElementById('mailboxSelector');
                    if (!selector) throw new Error('Mailbox selector not found');

                    selector.innerHTML = '<option value="">Select Mailbox</option>';

                    Object.keys(this.savedMailboxes)
                        .sort((a, b) => new Date(this.savedMailboxes[b].lastUsed) - new Date(this.savedMailboxes[a].lastUsed))
                        .forEach(email => {
                            const option = document.createElement('option');
                            option.value = email;
                            option.textContent = email;
                            if (email === this.currentEmail) {
                                option.selected = true;
                            }
                            selector.appendChild(option);
                        });
                } catch (error) {
                    console.error('updateMailboxSelector error:', error.message, error.stack);
                }
            }

            deleteCurrentMailbox() {
                try {
                    if (!this.currentEmail || !this.savedMailboxes[this.currentEmail]) {
                        throw new Error('No mailbox to delete');
                    }

                    const deletedEmail = this.currentEmail;
                    const btn = document.querySelector('button[onclick="deleteMailbox()"]');
                    delete this.savedMailboxes[this.currentEmail];
                    localStorage.setItem('tempmail_mailboxes', JSON.stringify(this.savedMailboxes));

                    if (localStorage.getItem('tempmail_last_used') === deletedEmail) {
                        localStorage.removeItem('tempmail_last_used');
                    }

                    if (btn) this.showStatus(btn, 'Mailbox deleted', 'success');

                    const remainingMailboxes = Object.keys(this.savedMailboxes);
                    if (remainingMailboxes.length > 0) {
                        const lastUsed = remainingMailboxes.sort((a, b) =>
                            new Date(this.savedMailboxes[b].lastUsed) - new Date(this.savedMailboxes[a].lastUsed)
                        )[0];
                        this.loadMailbox(lastUsed);
                    } else {
                        this.generateEmail();
                    }

                    this.updateMailboxSelector();
                    this.initializeTooltips();
                } catch (error) {
                    console.error('deleteCurrentMailbox error:', error.message, error.stack);
                }
            }

            clearAllEmails() {
                try {
                    const btn = document.querySelector('button[onclick="clearAllEmails()"]');
                    this.emails = [];
                    this.updateEmailList();
                    this.saveMailbox();
                    if (btn) this.showStatus(btn, 'Emails cleared', 'success');
                    this.initializeTooltips();
                } catch (error) {
                    console.error('clearAllEmails error:', error.message, error.stack);
                }
            }

            toggleAutoRefresh() {
                try {
                    const btn = document.getElementById('autoRefreshBtn');
                    if (!btn) throw new Error('Auto-refresh button not found');

                    if (this.refreshInterval) {
                        this.stopAutoRefresh();
                        btn.innerHTML = '<i class="fas fa-clock mr-2"></i>Auto-Refresh: OFF';
                        btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        btn.classList.add('bg-gray-600', 'hover:bg-gray-500');
                        this.showStatus(btn, 'Auto-refresh disabled', 'info');
                    } else {
                        this.startAutoRefresh();
                        btn.innerHTML = '<i class="fas fa-clock mr-2"></i>Auto-Refresh: ON';
                        btn.classList.remove('bg-gray-600', 'hover:bg-gray-500');
                        btn.classList.add('bg-green-600', 'hover:bg-green-700');
                        this.showStatus(btn, 'Auto-refresh enabled', 'success');
                    }
                    this.initializeTooltips();
                } catch (error) {
                    console.error('toggleAutoRefresh error:', error.message, error.stack);
                }
            }

            updateEmailDisplay() {
                try {
                    const display = document.getElementById('emailDisplay');
                    if (!display) throw new Error('Email display element not found');
                    display.textContent = this.currentEmail || 'No email generated';
                } catch (error) {
                    console.error('updateEmailDisplay error:', error.message, error.stack);
                }
            }

            updateEmailList() {
                try {
                    const emailList = document.getElementById('emailList');
                    const emailsContainer = document.getElementById('emails');
                    const emailCount = document.getElementById('emailCount');
                    const emptyInbox = document.getElementById('emptyInbox');

                    if (!emailList || !emailsContainer || !emailCount || !emptyInbox) {
                        throw new Error('Required email list DOM elements missing');
                    }

                    emailCount.textContent = this.emails.length;
                    emailList.classList.remove('hidden');

                    if (this.emails.length > 0) {
                        emailsContainer.style.display = 'block';
                        emptyInbox.classList.add('hidden');
                        emailsContainer.innerHTML = this.emails.map((email, index) => {
                            if (!email) return '';
                            return `
                                <div class="bg-gray-700 p-4 rounded-lg mb-2 hover:bg-blue-600/20 transition cursor-pointer border border-white !important ${index < 3 ? 'border-l-4 border-blue-400' : ''}" onclick="showEmailDetail(${index})">
                                    <h6 class="text-white !important truncate">${this.escapeHtml(email.subject || 'No Subject')}</h6>
                                    <p class="text-blue-100 !important text-sm"><i class="fas fa-user mr-1"></i>${this.escapeHtml(email.from ? email.from.address : 'Unknown Sender')}</p>
                                    <p class="text-white !important text-sm"><i class="fas fa-clock mr-1"></i>${this.formatDate(email.createdAt)}</p>
                                    <p class="text-gray-400 text-sm truncate">${this.escapeHtml(email.intro || 'Click to view')}</p>
                                </div>
                            `;
                        }).join('');
                    } else {
                        emailsContainer.style.display = 'none';
                        emptyInbox.classList.remove('hidden');
                    }
                    this.initializeTooltips();
                } catch (error) {
                    console.error('updateEmailList error:', error.message, error.stack);
                }
            }

            async showEmailDetail(index) {
                try {
                    const email = this.emails[index];
                    if (!email) throw new Error('Invalid email index');

                    const modalFrom = document.getElementById('modalFrom');
                    const modalSubject = document.getElementById('modalSubject');
                    const modalDate = document.getElementById('modalDate');
                    const modalContent = document.getElementById('modalContent');
                    const emailModal = document.getElementById('emailModal');

                    if (!modalFrom || !modalSubject || !modalDate || !modalContent || !emailModal) {
                        throw new Error('Required modal DOM elements missing');
                    }

                    modalFrom.textContent = email.from ? email.from.address : 'Unknown Sender';
                    modalSubject.textContent = email.subject || 'No Subject';
                    modalDate.textContent = this.formatDate(email.createdAt);
                    modalContent.innerHTML = '<div class="text-center text-gray-400"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

                    const modal = new bootstrap.Modal(emailModal);
                    modal.show();

                    const fullEmail = await this.getEmailContent(email.id);

                    if (fullEmail) {
                        if (fullEmail.html && Array.isArray(fullEmail.html) && fullEmail.html.length > 0) {
                            modalContent.innerHTML = this.sanitizeHtml(fullEmail.html[0]);
                        } else if (fullEmail.text) {
                            modalContent.innerHTML = `<pre class="text-white !important whitespace-pre-wrap">${this.escapeHtml(fullEmail.text)}</pre>`;
                        } else {
                            modalContent.innerHTML = '<p class="text-gray-400">No content available</p>';
                        }
                    } else {
                        modalContent.innerHTML = '<p class="text-red-400">Failed to load content</p>';
                    }
                    this.initializeTooltips();
                } catch (error) {
                    console.error('showEmailDetail error:', error.message, error.stack);
                    const modalContent = document.getElementById('modalContent');
                    if (modalContent) modalContent.innerHTML = '<p class="text-red-400">Error loading content</p>';
                }
            }

            async copyEmail() {
                try {
                    const display = document.getElementById('emailDisplay');
                    if (!display) throw new Error('Email display element not found');
                    if (!this.currentEmail) {
                        this.showStatus(display, 'No email to copy', 'warning');
                        return;
                    }

                    try {
                        await navigator.clipboard.writeText(this.currentEmail);
                        this.showStatus(display, 'Email copied!', 'success');
                        if (typeof trackEmailCopy === 'function') trackEmailCopy();
                    } catch (error) {
                        const textArea = document.createElement('textarea');
                        textArea.value = this.currentEmail;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        this.showStatus(display, 'Email copied!', 'success');
                        if (typeof trackEmailCopy === 'function') trackEmailCopy();
                    }
                } catch (error) {
                    console.error('copyEmail error:', error.message, error.stack);
                }
            }

            showStatus(element, message, type) {
                try {
                    if (!element) throw new Error('Status element not provided');

                    const existingTooltip = bootstrap.Tooltip.getInstance(element);
                    if (existingTooltip) existingTooltip.dispose();

                    element.setAttribute('data-bs-title', this.escapeHtml(message));
                    const tooltip = new bootstrap.Tooltip(element, {
                        trigger: 'manual',
                        placement: 'top',
                        customClass: `alert-${type}`
                    });
                    tooltip.show();

                    setTimeout(() => {
                        tooltip.hide();
                        element.setAttribute('data-bs-title', element.getAttribute('title') || '');
                    }, 1000);
                } catch (error) {
                    console.error('showStatus error:', error.message, error.stack);
                }
            }

            setRefreshButton(loading) {
                try {
                    const btn = document.getElementById('refreshBtn');
                    if (!btn) throw new Error('Refresh button not found');
                    btn.disabled = loading;
                    btn.innerHTML = loading
                        ? '<span class="loading-spinner mr-2"></span>Checking...'
                        : '<i class="fas fa-sync-alt mr-2"></i>Refresh';
                } catch (error) {
                    console.error('setRefreshButton error:', error.message, error.stack);
                }
            }

            startAutoRefresh() {
                try {
                    if (this.refreshInterval) clearInterval(this.refreshInterval);
                    this.refreshInterval = setInterval(() => {
                        if (this.currentEmail && this.currentToken) this.checkEmails();
                    }, 30000);
                } catch (error) {
                    console.error('startAutoRefresh error:', error.message, error.stack);
                }
            }

            stopAutoRefresh() {
                try {
                    if (this.refreshInterval) {
                        clearInterval(this.refreshInterval);
                        this.refreshInterval = null;
                    }
                } catch (error) {
                    console.error('stopAutoRefresh error:', error.message, error.stack);
                }
            }

            formatDate(dateString) {
                try {
                    if (!dateString) return 'Unknown date';
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return dateString;

                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMins / 60);
                    const diffDays = Math.floor(diffHours / 24);

                    if (diffMins < 1) return 'Just now';
                    if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
                    if (diffHours < 24) return `${diffHours} hr${diffHours > 1 ? 's' : ''} ago`;
                    if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
                    return date.toLocaleDateString();
                } catch (error) {
                    console.error('formatDate error:', error.message, error.stack);
                    return dateString;
                }
            }

            escapeHtml(text) {
                try {
                    if (typeof text !== 'string') return text;
                    const map = {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#039;'
                    };
                    return text.replace(/[&<>"']/g, m => map[m]);
                } catch (error) {
                    console.error('escapeHtml error:', error.message, error.stack);
                    return text;
                }
            }

            sanitizeHtml(html) {
                try {
                    if (typeof html !== 'string') return '';
                    return html
                        .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                        .replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi, '')
                        .replace(/on\w+\s*=\s*"[^"]*"/gi, '')
                        .replace(/on\w+\s*=\s*'[^']*'/gi, '')
                        .replace(/javascript:/gi, '');
                } catch (error) {
                    console.error('sanitizeHtml error:', error.message, error.stack);
                    return '';
                }
            }
        }

        let tempMail = null;
        document.addEventListener('DOMContentLoaded', () => {
            try {
                tempMail = new TempMail();
                const generateBtn = document.querySelector('button[onclick="generateEmail()"]');
                if (generateBtn) {
                    tempMail.showStatus(generateBtn, 'Welcome to TempMail! Generate an email.', 'info');
                }
            } catch (error) {
                console.error('DOMContentLoaded error:', error.message, error.stack);
            }
        });

        function generateEmail() {
            if (tempMail) tempMail.generateEmail();
        }

        function checkEmails() {
            if (tempMail) tempMail.checkEmails();
        }

        function copyEmail() {
            if (tempMail) tempMail.copyEmail();
        }

        function showEmailDetail(index) {
            if (tempMail) tempMail.showEmailDetail(index);
        }

        function switchMailbox() {
            try {
                const selector = document.getElementById('mailboxSelector');
                if (!selector) return;
                const selectedEmail = selector.value;
                if (selectedEmail && selectedEmail !== tempMail.currentEmail) {
                    tempMail.loadMailbox(selectedEmail);
                }
            } catch (error) {
                console.error('switchMailbox error:', error.message, error.stack);
            }
        }

        function deleteMailbox() {
            try {
                if (confirm('Delete this mailbox? This cannot be undone.')) {
                    tempMail.deleteCurrentMailbox();
                }
            } catch (error) {
                console.error('deleteMailbox error:', error.message, error.stack);
            }
        }

        function clearAllEmails() {
            try {
                if (confirm('Clear all emails from this mailbox?')) {
                    tempMail.clearAllEmails();
                }
            } catch (error) {
                console.error('clearAllEmails error:', error.message, error.stack);
            }
        }

        function toggleAutoRefresh() {
            if (tempMail) tempMail.toggleAutoRefresh();
        }

        window.addEventListener('beforeunload', () => {
            try {
                if (tempMail) tempMail.stopAutoRefresh();
            } catch (error) {
                console.error('beforeunload error:', error.message, error.stack);
            }
        });
    </script>
</body>
</html>